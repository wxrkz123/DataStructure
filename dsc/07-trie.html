<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trie (字典树/前缀树) - 权威交互式可视化</title>

    <!-- Dependencies -->
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/notyf@3/notyf.min.css">
    <script src="https://cdn.jsdelivr.net/npm/notyf@3/notyf.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        .notyf__message { color: #334155; }
        .explanation-icon { font-size: 1.5rem; margin-right: 0.75rem; opacity: 0.8; }
        .op-button { padding: 10px 16px; border-radius: 8px; font-weight: 600; transition: all 0.2s ease; border: 1px solid transparent; display: flex; align-items: center; gap: 8px; }
        .op-button:disabled { background-color: #e2e8f0; color: #94a3b8; cursor: not-allowed; }
        .op-button:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1); }
        .legend-item { display: flex; align-items: center; gap: 10px; }
        .legend-symbol { width: 20px; height: 20px; border: 2px solid #000; }
        .tooltip-address { font-family: 'Courier New', Courier, monospace; background-color: #e0e7ff; color: #4338ca; padding: 1px 4px; border-radius: 4px; font-weight: bold; }
        .tooltip-value { font-family: 'Courier New', Courier, monospace; background-color: #dcfce7; color: #15803d; padding: 1px 4px; border-radius: 4px; font-weight: bold; }
        .op-card { transition: all 0.2s ease; border-left-width: 5px; }
        .op-card.active { border-left-color: #3b82f6; background-color: #eff6ff; }
    </style>
</head>
<body class="bg-slate-100 overflow-hidden">

<div id="app" class="flex flex-col h-screen p-4 gap-4">
    <header class="bg-white/90 backdrop-blur-lg shadow-lg rounded-xl p-4 z-20 shrink-0">
        <div class="max-w-7xl mx-auto">
            <h1 class="text-3xl font-bold text-slate-800 text-center mb-2">Trie (字典树 / 前缀树) - 权威交互式可视化</h1>
            <p class="text-center text-slate-600 mb-4">输入一个单词，选择操作以创建任务，然后通过“下一步”或控制卡片来观察执行过程。</p>
            <div class="flex justify-center items-center gap-4">
                <input v-model="userInput" @keyup.enter="createInsertOp" type="text" placeholder="例如: apple" class="w-48 text-center border-slate-300 rounded-md shadow-sm">
                <div class="flex gap-3 bg-slate-100 p-2 rounded-lg">
                    <button @click="createInsertOp" class="op-button bg-sky-100 text-sky-700 hover:bg-sky-200"><i class="fa-solid fa-plus"></i> 插入</button>
                    <button @click="createSearchOp" class="op-button bg-amber-100 text-amber-700 hover:bg-amber-200"><i class="fa-solid fa-magnifying-glass"></i> 搜索</button>
                    <button @click="createPrefixSearchOp" class="op-button bg-purple-100 text-purple-700 hover:bg-purple-200"><i class="fa-solid fa-star"></i> 前缀搜索</button>
                </div>
                <button @click="resetAll" class="bg-red-600 hover:bg-red-700 text-white font-semibold py-2 px-5 rounded-md transition flex items-center gap-2"><i class="fa-solid fa-power-off"></i> 重置系统</button>
                <button @click="nextStep" :disabled="!activeOperation || activeOperation.status === 'Finished'" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-8 rounded-md transition disabled:bg-slate-400 flex items-center gap-2 text-lg">下一步 <i class="fa-solid fa-forward-step"></i></button>
            </div>
        </div>
    </header>

    <main class="flex-grow grid grid-cols-12 gap-4 min-h-0">
        <div class="col-span-12 lg:col-span-4 bg-white shadow-lg rounded-xl p-4 flex flex-col">
            <div class="flex-1 flex flex-col min-h-0">
                 <h2 class="text-xl font-bold text-slate-700 mb-2 border-b pb-2 shrink-0"><i class="fa-solid fa-tasks text-indigo-600"></i> 操作历史记录 (Operations)</h2>
                <div class="flex-grow bg-slate-50 p-2 rounded-lg overflow-y-auto space-y-2">
                    <p v-if="operationsQueue.length === 0" class="text-center text-slate-500 pt-16">请发起一个操作...</p>
                    <div v-for="op in operationsQueue" :key="op.id" @click="setActiveOperation(op.id)"
                         :class="{ 'active': op.id === activeOperationId }"
                         class="op-card cursor-pointer bg-white p-3 rounded-lg shadow-sm border-l-slate-200 hover:bg-blue-50">
                        <div class="flex justify-between items-center">
                            <div class="font-semibold text-slate-800 flex items-center gap-2">
                                <i :class="op.icon" :style="{color: op.color}"></i>
                                <span>{{ op.type }}: "{{ op.word }}"</span>
                            </div>
                            <button @click.stop="cancelOperation(op.id)" class="text-slate-400 hover:text-red-500 transition-colors"><i class="fas fa-times-circle"></i></button>
                        </div>
                        <div class="flex items-center gap-2 mt-2">
                            <div class="w-full bg-slate-200 rounded-full h-1.5"><div class="bg-blue-500 h-1.5 rounded-full" :style="{ width: op.progress + '%' }"></div></div>
                            <span class="text-xs font-mono text-slate-500">{{ op.status }}</span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="mt-4 pt-4 border-t">
                <h2 class="text-xl font-bold text-slate-700 mb-2 border-b pb-2 shrink-0"><i class="fa-solid fa-tags text-slate-500"></i> 图例 (Legend)</h2>
                 <div class="grid grid-cols-2 gap-x-4 gap-y-3 text-sm text-slate-600 font-medium p-2">
                    <div class="legend-item"><div class="legend-symbol rounded-full bg-white border-slate-600"></div><span>中间节点 (Node)</span></div>
                    <div class="legend-item"><div class="legend-symbol rounded-md bg-white border-red-500" style="border-width: 3px;"></div><span>单词结尾 (End of Word)</span></div>
                    <div class="legend-item"><div class="legend-symbol rounded-full bg-amber-100 border-amber-500"></div><span>当前路径 (Path)</span></div>
                    <div class="legend-item"><div class="legend-symbol rounded-full bg-sky-100 border-sky-500"></div><span>新创建 (New)</span></div>
                    <div class="legend-item"><div class="legend-symbol rounded-full bg-green-100 border-green-500"></div><span>查找成功 (Found)</span></div>
                    <div class="legend-item"><div class="legend-symbol rounded-full bg-red-100 border-red-500"></div><span>查找失败 (Failed)</span></div>
                </div>
            </div>
        </div>
        
        <div class="col-span-12 lg:col-span-8 bg-white shadow-lg rounded-xl p-4 flex flex-col">
            <h2 class="text-xl font-bold text-slate-700 mb-2 border-b pb-2 text-center shrink-0">
                <i class="fa-solid fa-microscope text-sky-600"></i> 执行分析:
                <span v-if="activeOperation" class="text-indigo-600 font-mono">{{ activeOperation.type }}("{{ activeOperation.word }}")</span>
                <span v-else class="text-slate-400">无激活操作</span>
            </h2>
            <div class="flex-grow bg-sky-50 p-4 rounded-lg text-slate-800 overflow-y-auto">
                 <div class="flex items-start">
                    <i :class="currentExplanation.icon" class="explanation-icon" :style="{ color: currentExplanation.color }"></i>
                    <p v-html="currentExplanation.text" class="transition-opacity duration-300 flex-1"></p>
                </div>
            </div>
            <div class="flex-grow mt-4">
                <div id="echarts-trie-container" class="w-full h-full"></div>
            </div>
        </div>
    </main>
</div>

<script>
    const { createApp, ref, computed, onMounted } = Vue;

    let memoryCounter = 0x1000;
    const allocateAddress = () => `0x${(memoryCounter += Math.floor(Math.random() * 12 + 8) * 8).toString(16).toUpperCase()}`;

    class TrieNode {
        constructor(char = null) { this.char = char; this.children = {}; this.isEndOfWord = false; this.address = allocateAddress(); this.highlight = null; this.isPathEdge = false; }
    }

    createApp({
        setup() {
            const notyf = new Notyf(); let chartInstance = null;
            
            const root = ref(null); const userInput = ref('');
            const operationsQueue = ref([]); const activeOperationId = ref(null);
            
            const activeOperation = computed(() => operationsQueue.value.find(op => op.id === activeOperationId.value));
            const currentExplanation = computed(() => {
                const op = activeOperation.value;
                if (!op || op.currentStep < 0) return { text: '请选择一个操作并点击“下一步”开始。', icon: 'fa-solid fa-hand-pointer', color: '#8b5cf6' };
                return op.steps[op.currentStep].explanation;
            });
            
            const findNodeByPath = (path) => { let c = root.value; for (const char of path) { if (!c || !c.children[char]) return null; c = c.children[char]; } return c; };
            const transformToEchartsData = (trieNode) => {
                if (!trieNode) return null;
                const char = trieNode.char === null ? 'ROOT' : trieNode.char;
                const item = {
                    name: char, children: [], address: trieNode.address, isEndOfWord: trieNode.isEndOfWord,
                    symbol: 'circle', symbolSize: 45, itemStyle: { borderColor: '#64748b', color: '#f1f5f9', borderWidth: 2 }, lineStyle: { color: '#cbd5e1', width: 2 }
                };
                if (trieNode.highlight === 'path') { item.itemStyle.color = '#fef3c7'; item.itemStyle.borderColor = '#f59e0b'; }
                if (trieNode.highlight === 'found') { item.itemStyle.color = '#dcfce7'; item.itemStyle.borderColor = '#22c55e'; }
                if (trieNode.highlight === 'new') { item.itemStyle.color = '#dbeafe'; item.itemStyle.borderColor = '#3b82f6'; }
                if (trieNode.highlight === 'fail') { item.itemStyle.color = '#fee2e2'; item.itemStyle.borderColor = '#ef4444'; }
                if (trieNode.isPathEdge) { item.lineStyle.color = '#f59e0b'; item.lineStyle.width = 3; }
                if (trieNode.isEndOfWord) { item.symbol = 'rect'; item.symbolSize = [45, 45]; item.itemStyle.borderWidth = 3; if(trieNode.highlight !== 'found') item.itemStyle.borderColor = '#ef4444'; }
                const childrenKeys = Object.keys(trieNode.children).sort();
                for (const key of childrenKeys) { item.children.push(transformToEchartsData(trieNode.children[key])); }
                return item;
            };

            const updateChart = () => { if (chartInstance) chartInstance.setOption({ series: [{ data: [transformToEchartsData(root.value)] }], animationDurationUpdate: 300 }); };

            const createOperation = (type, word, generatorFunc, icon, color) => {
                if (!/^[a-z]*$/.test(word)) { notyf.error('请输入小写英文字母。'); return; }
                if (word.length === 0) { notyf.error('输入不能为空。'); return; }
                const steps = generatorFunc(word);
                const newOp = {
                    id: Date.now(), type, word, steps, currentStep: -1, status: 'Ready', progress: 0, icon, color
                };
                operationsQueue.value.push(newOp);
                setActiveOperation(newOp.id);
            };

            const createInsertOp = () => createOperation('插入', userInput.value, generateInsertSteps, 'fa-solid fa-plus', '#0ea5e9');
            const createSearchOp = () => createOperation('搜索', userInput.value, (w) => generateSearchSteps(w, false), 'fa-solid fa-magnifying-glass', '#f59e0b');
            const createPrefixSearchOp = () => createOperation('前缀搜索', userInput.value, (w) => generateSearchSteps(w, true), 'fa-solid fa-star', '#8b5cf6');

            const generateInsertSteps = (word) => {
                let steps = []; let current = root.value; let path = "";
                steps.push({ explanation: { text: `开始插入单词 <b class="text-sky-600">"${word}"</b>`, icon: 'fa-solid fa-seedling', color: '#0ea5e9' } });
                let i = 0;
                for (; i < word.length; i++) {
                    const char = word[i];
                    steps.push({ explanation: { text: `从当前 Node (节点) 出发，寻找代表字符 <b class="text-sky-600">'${char}'</b> 的 Edge (边)。`, icon: 'fa-solid fa-magnifying-glass' }, action: { type: 'highlight_path', path: path } });
                    if (!current.children[char]) break;
                    path += char;
                    steps.push({ explanation: { text: `找到路径 <b class="text-sky-600">'${char}'</b>，沿此 Path (路径) 向下移动。`, icon: 'fa-solid fa-person-walking-arrow-right' }, action: { type: 'highlight_path', path: path }});
                    current = current.children[char];
                }
                for (; i < word.length; i++) {
                    const charToCreate = word[i];
                    steps.push({ explanation: { text: `Path (路径) <b class="text-sky-600">'${charToCreate}'</b> 不存在，<b>创建新 Node (节点)</b>。`, icon: 'fa-solid fa-plus-circle', color: '#3b82f6' }, action: { type: 'create_node', parentPath: path, char: charToCreate } });
                    path += charToCreate;
                }
                steps.push({ explanation: { text: `单词 <b class="text-sky-600">"${word}"</b> 的路径已完整。将最终节点标记为 <b class="text-red-600">End of Word (单词结尾)</b>。`, icon: 'fa-solid fa-flag-checkered', color: '#ef4444' }, action: { type: 'mark_end', path: path } });
                steps.push({ explanation: { text: `插入操作 <b class="text-green-600">完成</b>！`, icon: 'fa-solid fa-party-horn', color: '#16a34a' } });
                return steps;
            };

            const generateSearchSteps = (word, isPrefixSearch) => {
                const type = isPrefixSearch ? '前缀搜索 (Prefix Search)' : '搜索 (Search)';
                let steps = []; let current = root.value; let path = ""; let found = true;
                steps.push({ explanation: { text: `开始执行<b class="text-amber-600">${type}</b>，目标为 <b class="text-amber-600">"${word}"</b>。`, icon: 'fa-solid fa-search', color: '#f59e0b' } });
                for (let i = 0; i < word.length; i++) {
                    const char = word[i];
                    steps.push({ explanation: { text: `寻找字符路径 <b class="text-amber-600">'${char}'</b>。`, icon: 'fa-solid fa-magnifying-glass' }, action: { type: 'highlight_path', path: path } });
                    if (!current.children[char]) {
                        steps.push({ explanation: { text: `路径中断！未找到子节点 <b class="text-amber-600">'${char}'</b>。<br><b class="text-red-600">查找失败 (Failed)</b>。`, icon: 'fa-solid fa-times-circle', color: '#ef4444' }, action: { type: 'highlight', path: path, style: 'fail' } });
                        found = false; break;
                    }
                    path += char;
                    steps.push({ explanation: { text: `找到路径 <b class="text-amber-600">'${char}'</b>，向下移动。`, icon: 'fa-solid fa-person-walking-arrow-right' }, action: { type: 'highlight_path', path: path } });
                    current = current.children[char];
                }
                if (found) {
                    if (isPrefixSearch) {
                        steps.push({ explanation: { text: `Prefix (前缀) <b class="text-amber-600">"${word}"</b> 的路径完整存在。<br><b class="text-green-600">前缀查找成功 (Found)！</b>`, icon: 'fa-solid fa-check-circle', color: '#16a34a' }, action: { type: 'highlight', path: path, style: 'found' } });
                    } else {
                        steps.push({ explanation: { text: `单词路径已走完。现在检查当前节点是否为 <b class="text-red-600">End of Word (单词结尾)</b>。`, icon: 'fa-solid fa-flag-checkered' } });
                        if (current.isEndOfWord) {
                            steps.push({ explanation: { text: `该节点是单词结尾。<br><b class="text-green-600">单词查找成功 (Found)！</b>`, icon: 'fa-solid fa-check-circle', color: '#16a34a' }, action: { type: 'highlight', path: path, style: 'found' } });
                        } else {
                            steps.push({ explanation: { text: `该节点不是单词结尾 (它只是一个前缀)。<br><b class="text-red-600">单词查找失败 (Failed)！</b>`, icon: 'fa-solid fa-times-circle', color: '#ef4444' }, action: { type: 'highlight', path: path, style: 'fail' } });
                        }
                    }
                }
                steps.push({ explanation: { text: `操作 <b class="text-green-600">完成</b>！`, icon: 'fa-solid fa-party-horn', color: '#16a34a' } });
                return steps;
            };

            const nextStep = () => {
                const op = activeOperation.value;
                if (!op || op.status === 'Finished') return;
                
                op.status = 'Running';
                op.currentStep++;
                op.progress = ((op.currentStep + 1) / op.steps.length) * 100;

                if (op.currentStep >= op.steps.length - 1) {
                    op.status = 'Finished';
                }

                const step = op.steps[op.currentStep];
                applyAction(step.action);
            };

            const applyAction = (action) => {
                (function clear(node){ if(node){ node.highlight = null; node.isPathEdge = false; Object.values(node.children).forEach(clear); }})(root.value);

                if (!action) { updateChart(); return; }

                let path = action.path || action.parentPath || "";
                let current = root.value;
                current.highlight = 'path';
                for(let i = 0; i < path.length; i++) {
                    const char = path[i];
                    if (current.children[char]) {
                        current = current.children[char];
                        current.highlight = 'path';
                        current.isPathEdge = true;
                    }
                }

                switch (action.type) {
                    case 'highlight': current.highlight = action.style; break;
                    case 'create_node': 
                        if (!current.children[action.char]) current.children[action.char] = new TrieNode(action.char);
                        current.children[action.char].highlight = 'new';
                        current.children[action.char].isPathEdge = true;
                        break;
                    case 'mark_end': current.isEndOfWord = true; current.highlight = 'found'; break;
                }
                updateChart();
            };
            
            const setActiveOperation = (id) => {
                activeOperationId.value = id;
                const op = activeOperation.value;
                if(op) applyAction(op.steps[op.currentStep]?.action);
                else updateChart();
            };
            
            const cancelOperation = (id) => {
                const index = operationsQueue.value.findIndex(op => op.id === id);
                if(index > -1) {
                    operationsQueue.value.splice(index, 1);
                    if(activeOperationId.value === id) {
                         activeOperationId.value = operationsQueue.value.length > 0 ? operationsQueue.value[operationsQueue.value.length - 1].id : null;
                         setActiveOperation(activeOperationId.value);
                    }
                }
            };

            const resetAll = () => {
                operationsQueue.value = []; activeOperationId.value = null;
                userInput.value = ''; memoryCounter = 0x1000; root.value = new TrieNode();
                (function clear(node){ if(node){ node.highlight = null; node.isPathEdge = false; Object.values(node.children).forEach(clear); }})(root.value);
                updateChart();
                notyf.success('系统已完全重置。');
            };

            onMounted(() => {
                chartInstance = echarts.init(document.getElementById('echarts-trie-container'), null, { renderer: 'svg' });
                chartInstance.setOption({
                    tooltip: {
                        trigger: 'item', triggerOn: 'mousemove', confine: true,
                        backgroundColor: 'rgba(255,255,255,0.95)', borderWidth: 1, borderColor: '#e2e8f0',
                        formatter: (params) => {
                            if (!params.data.address) return;
                            return `<div class="p-1 text-sm">
                                <strong>Node (节点):</strong> <span class="tooltip-value">${params.name}</span><br>
                                <strong>地址 (Address):</strong> <span class="tooltip-address">${params.data.address}</span><br>
                                <strong>单词结尾 (End of Word):</strong> ${params.data.isEndOfWord ? '<span class="text-red-600 font-bold">true</span>' : 'false'}
                            </div>`;
                        }
                    },
                    series: [{ type: 'tree', data: [], symbol: 'circle', symbolSize: 45, orient: 'TB', edgeShape: 'curve', initialTreeDepth: -1, expandAndCollapse: false, label: { show: true, position: 'inside', fontSize: 16, color: '#0f172a', fontWeight: 'bold' }, emphasis: { disabled: true } }]
                });
                resetAll();
                window.addEventListener('resize', () => chartInstance.resize());
            });

            return { userInput, operationsQueue, activeOperationId, activeOperation, currentExplanation, createInsertOp, createSearchOp, createPrefixSearchOp, nextStep, setActiveOperation, cancelOperation, resetAll };
        }
    }).mount('#app');
</script>

</body>
</html>