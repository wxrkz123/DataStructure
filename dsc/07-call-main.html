<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>C语言函数调用栈 - 深度工作原理演示 (纵向布局)</title>

    <!-- Dependencies -->
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/notyf@3/notyf.min.css">
    <script src="https://cdn.jsdelivr.net/npm/notyf@3/notyf.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        .notyf__message { color: #334155; }
        .code-line-wrapper { display: flex; align-items: flex-start; padding: 4px 10px; border-radius: 4px; transition: background-color 0.3s ease; font-size: 0.8rem; border-left: 3px solid transparent; }
        .code-line-wrapper.highlight { background-color: rgba(255, 255, 255, 0.15); border-left-color: #facc15; }
        .line-number { text-align: right; width: 1.5em; margin-right: 1.5em; color: #94a3b8; user-select: none; }
        .code-text { white-space: pre-wrap; font-weight: 500; flex: 1; }
        .stack-frame { transition: all 0.4s ease-in-out; transform-origin: center; border-left-width: 5px; }
        .param, .local-var { font-family: 'Courier New', Courier, monospace; background-color: #e0e7ff; color: #4338ca; padding: 2px 5px; border-radius: 4px; font-weight: bold; }
        .value { font-family: 'Courier New', Courier, monospace; background-color: #dcfce7; color: #15803d; padding: 2px 5px; border-radius: 4px; font-weight: bold; }
        .explanation-icon { font-size: 1.5rem; margin-right: 0.75rem; opacity: 0.8; }
        .return-value { margin-top: 8px; padding: 8px; border-radius: 6px; background-color: #f3e8ff; color: #7e22ce; text-align: center; font-weight: 600; font-size: 0.9rem; }
    </style>
</head>
<body class="bg-slate-100">

<div id="app" class="flex flex-col h-screen p-4 gap-4">

    <!-- Header and Controls -->
    <header class="bg-white/90 backdrop-blur-lg shadow-lg rounded-xl p-4 z-20 shrink-0">
        <div class="max-w-7xl mx-auto">
            <h1 class="text-3xl font-bold text-slate-800 text-center mb-2">函数调用与调用栈工作原理 - C语言深度解析</h1>
            <p class="text-center text-slate-600 mb-4">通过手动控制，观察函数调用、参数传递、局部变量和返回值的完整生命周期。</p>
            <div class="flex justify-center items-center gap-4">
                <button @click="startAnimation" :disabled="isBusy" class="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 px-5 rounded-md transition disabled:bg-slate-400 flex items-center gap-2">
                    <i class="fa-solid fa-play"></i> 开始演示
                </button>
                 <button @click="reset" class="bg-slate-600 hover:bg-slate-700 text-white font-semibold py-2 px-5 rounded-md transition flex items-center gap-2">
                    <i class="fa-solid fa-arrows-rotate"></i> 重置视图
                </button>
                 <button @click="nextStep" :disabled="!isBusy || isFinished" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-8 rounded-md transition disabled:bg-slate-400 flex items-center gap-2 text-lg">
                    下一步 <i class="fa-solid fa-forward-step"></i>
                </button>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="flex-grow grid grid-cols-1 lg:grid-cols-3 gap-4 min-h-0">

        <!-- Left Panel: Code & Explanation -->
        <div class="bg-white shadow-lg rounded-xl p-4 flex flex-col min-h-0">
            <h2 class="text-xl font-bold text-slate-700 mb-2 border-b pb-2 shrink-0">C 代码执行流程</h2>
            <div class="font-mono bg-slate-800 text-white p-3 rounded-lg text-sm overflow-auto mb-4">
                <div v-for="(line, index) in code" :key="index" :class="{'highlight': index === activeLine}" class="code-line-wrapper">
                    <span class="line-number">{{ index + 1 }}</span>
                    <span class="code-text" v-html="line.text"></span>
                </div>
            </div>
             <h2 class="text-xl font-bold text-slate-700 mb-2 border-b pb-2 shrink-0">
                <i class="fa-solid fa-comment-dots text-sky-600"></i> 动画讲解
             </h2>
            <div class="flex-grow bg-sky-50 p-4 rounded-lg text-slate-800 overflow-y-auto">
                <div class="flex items-start">
                    <i :class="explanation.icon" class="explanation-icon text-sky-600"></i>
                    <p v-html="explanation.text" class="transition-opacity duration-300 flex-1"></p>
                </div>
            </div>
        </div>

        <!-- Center Panel: Function Flow Visualization -->
        <div class="bg-white shadow-lg rounded-xl p-4 flex flex-col min-h-0">
            <h2 class="text-xl font-bold text-slate-700 mb-2 border-b pb-2 text-center shrink-0">函数调用关系图</h2>
            <div id="echarts-flow-container" class="w-full flex-grow min-h-0"></div>
        </div>

        <!-- Right Panel: Call Stack -->
        <div class="bg-white shadow-lg rounded-xl p-4 flex flex-col min-h-0">
            <h2 class="text-xl font-bold text-slate-700 mb-2 border-b pb-2 shrink-0">调用栈 (Call Stack)</h2>
            <div class="flex-grow bg-slate-50 p-2 rounded-lg space-y-2 overflow-y-auto">
                 <div v-if="callStack.length === 0" class="text-center text-slate-500 pt-8">
                     <i class="fa-solid fa-layer-group text-4xl mb-2"></i>
                     <p>点击"开始演示"以观察调用栈</p>
                 </div>
                 <div v-for="(frame, index) in callStack" :key="frame.id" class="stack-frame bg-white p-3 rounded-lg shadow-md" :style="{ 'border-left-color': frame.color }">
                    <div class="flex justify-between items-center">
                        <span class="font-bold text-slate-800 text-lg">{{ frame.functionName }}</span>
                        <span class="text-xs font-mono text-white px-2 py-0.5 rounded-full" :class="frame.statusClass">{{ frame.statusText }}</span>
                    </div>
                    <hr class="my-2">
                    <div class="text-sm space-y-2 font-mono">
                        <div v-if="Object.keys(frame.params).length > 0">
                           <p><strong>参数 (Parameters):</strong></p>
                           <div class="pl-4">
                             <p v-for="(val, key) in frame.params" :key="key"><span class="param">{{ key }}</span> = <span class="value">{{ val }}</span></p>
                           </div>
                        </div>
                         <div v-if="Object.keys(frame.locals).length > 0">
                           <p><strong>局部变量 (Local Vars):</strong></p>
                           <div class="pl-4">
                             <p v-for="(val, key) in frame.locals" :key="key"><span class="param">{{ key }}</span> = <span class="value">{{ val }}</span></p>
                           </div>
                        </div>
                    </div>
                    <div v-if="frame.returnValue !== undefined" class="return-value">
                        <i class="fa-solid fa-arrow-left-long"></i> 返回值: <span class="value">{{ frame.returnValue }}</span>
                    </div>
                 </div>
            </div>
        </div>

    </main>
</div>

<script>
    const { createApp, ref, reactive, onMounted } = Vue;

    createApp({
        setup() {
            let chartInstance = null;
            const isBusy = ref(false);
            const isFinished = ref(true);
            const notyf = new Notyf({ duration: 2000, position: { x: 'top', y: 'center' } });

            const explanation = ref({ text: '点击“开始演示”按钮，逐步探索C语言函数调用的奥秘。', icon: 'fa-solid fa-circle-info' });
            const activeLine = ref(-1);
            const callStack = ref([]);
            const animationSteps = ref([]);
            const currentStepIndex = ref(-1);
            
            const code = ref([
                { text: `// 功能：计算一个数的平方再加上一个固定的奖励值`},
                { text: `int calculate_score(int base_val) {` },
                { text: `    int squared = base_val * base_val;` },
                { text: `    int bonus = 50;` },
                { text: `    return squared + bonus;` },
                { text: `}` },
                { text: ``},
                { text: `// 程序主入口`},
                { text: `int main() {` },
                { text: `    int start_num = 10;` },
                { text: `    int final_result;` },
                { text: ``},
                { text: `    final_result = calculate_score(start_num);` },
                { text: ``},
                { text: `    return 0;` },
                { text: `}` },
            ]);
            
            const reset = () => {
                isBusy.value = false;
                isFinished.value = true;
                animationSteps.value = [];
                currentStepIndex.value = -1;
                callStack.value = [];
                activeLine.value = -1;
                explanation.value = { text: '点击“开始演示”按钮，逐步探索C语言函数调用的奥秘。', icon: 'fa-solid fa-circle-info' };
                updateChart('main', 'inactive');
                updateChart('calculate_score', 'inactive');
                notyf.success('视图已重置。');
            };

            const generateAnimationSteps = () => {
                animationSteps.value = [
                    // Step 1: Start main
                    { line: 9, exp: {text: `程序开始执行，进入 <span class="param">main</span> 函数。操作系统为其在“调用栈”上创建一个专属的内存空间，我们称之为“栈帧”。`, icon: 'fa-solid fa-power-off'}, 
                      action: { type: 'stackPush', frame: {id: 1, color: '#3b82f6', functionName: 'main', statusText: '执行中', statusClass: 'bg-blue-600', params: {}, locals: {}} },
                      chart: { node: 'main', status: 'active' }
                    },
                    // Step 2: Declare start_num
                    { line: 10, exp: {text: `在 <span class="param">main</span> 函数的栈帧内，声明一个局部变量 <span class="param">start_num</span> 并赋值为 <span class="value">10</span>。`, icon: 'fa-solid fa-pen-ruler'}, 
                      action: { type: 'updateLocals', newLocals: {start_num: 10} }
                    },
                     // Step 3: Declare final_result
                    { line: 11, exp: {text: `声明另一个局部变量 <span class="param">final_result</span>。此时它还未被赋值，内存中是一个不确定的值。`, icon: 'fa-solid fa-box'}, 
                      action: { type: 'updateLocals', newLocals: {final_result: '??'} }
                    },
                    // Step 4: Prepare to call calculate_score
                    { line: 13, exp: {text: `<b>关键点：</b><span class="param">main</span> 函数准备调用 <span class="param">calculate_score</span> 函数。它将局部变量 <span class="param">start_num</span> 的值 (<span class="value">10</span>)作为参数传递过去。`, icon: 'fa-solid fa-people-arrows'}, 
                      action: { type: 'updateStatus', statusText: '调用函数...', statusClass: 'bg-amber-500' },
                      chart: { node: 'calculate_score', status: 'highlight' }
                    },
                    // Step 5: Push calculate_score frame
                    { line: 2, exp: {text: `<b>调用栈变化！</b>一个新的栈帧被“压入”到调用栈的顶部，专属于 <span class="param">calculate_score</span>。注意，<span class="param">main</span> 的栈帧依然存在，只是暂时“暂停”了。`, icon: 'fa-solid fa-layer-group'}, 
                      action: { type: 'stackPush', frame: {id: 2, color: '#16a34a', functionName: 'calculate_score', statusText: '执行中', statusClass: 'bg-blue-600', params: {base_val: 10}, locals: {}} },
                      chart: { node: 'calculate_score', status: 'active' }
                    },
                     { line: 2, exp: {text: `从 <span class="param">main</span> 传来的值 <span class="value">10</span> 被复制给了 <span class="param">calculate_score</span> 的参数 <span class="param">base_val</span>。`, icon: 'fa-solid fa-copy'}, 
                    },
                    // Step 6: Execute inside calculate_score
                    { line: 3, exp: {text: `在 <span class="param">calculate_score</span> 的栈帧内，创建局部变量 <span class="param">squared</span>，并计算 <span class="value">10</span> * <span class="value">10</span>，结果为 <span class="value">100</span>。`, icon: 'fa-solid fa-calculator'}, 
                      action: { type: 'updateLocals', newLocals: {squared: 100} }
                    },
                    // Step 7: Create another local var
                    { line: 4, exp: {text: `创建另一个局部变量 <span class="param">bonus</span> 并赋值为 <span class="value">50</span>。每个函数的变量都存在于自己的栈帧中，互不干扰。`, icon: 'fa-solid fa-gift'}, 
                      action: { type: 'updateLocals', newLocals: {bonus: 50} }
                    },
                    // Step 8: Return from calculate_score
                    { line: 5, exp: {text: `函数准备返回。计算 <span class="param">squared</span> + <span class="param">bonus</span> (<span class="value">100</span> + <span class="value">50</span>)，得到返回值 <span class="value">150</span>。`, icon: 'fa-solid fa-right-from-bracket'}, 
                      action: { type: 'setReturn', value: 150, statusText: '即将返回', statusClass: 'bg-purple-600' }
                    },
                    // Step 9: Pop calculate_score frame
                    { line: 13, exp: {text: `<b>调用栈再次变化！</b><span class="param">calculate_score</span> 函数执行完毕，它的栈帧从调用栈顶部被“弹出”并销毁。它所有的局部变量 (<span class="param">squared</span>, <span class="param">bonus</span>) 也随之消失。`, icon: 'fa-solid fa-person-falling-burst'}, 
                      action: { type: 'stackPop' },
                      chart: { node: 'calculate_score', status: 'inactive' }
                    },
                    // Step 10: Resume main and assign value
                    { line: 13, exp: {text: `程序控制权回到 <span class="param">main</span> 函数暂停的地方。从 <span class="param">calculate_score</span> 返回的值 <span class="value">150</span> 被赋给局部变量 <span class="param">final_result</span>。`, icon: 'fa-solid fa-download'}, 
                      action: { type: 'multi', actions: [
                          { type: 'updateStatus', statusText: '恢复执行', statusClass: 'bg-blue-600' },
                          { type: 'updateLocals', newLocals: {final_result: 150} }
                      ]},
                      chart: { node: 'main', status: 'active' }
                    },
                    // Step 11: Return from main
                    { line: 15, exp: {text: `<span class="param">main</span> 函数执行到结尾，准备返回 <span class="value">0</span> 给操作系统。`, icon: 'fa-solid fa-flag-checkered'}, 
                      action: { type: 'setReturn', value: 0, statusText: '即将返回', statusClass: 'bg-purple-600' }
                    },
                    // Step 12: Pop main
                    { line: 16, exp: {text: `<span class="param">main</span> 函数的栈帧被弹出，调用栈变空。整个程序执行结束！`, icon: 'fa-solid fa-door-open'}, 
                      action: { type: 'stackPop' },
                      chart: { node: 'main', status: 'inactive' }
                    },
                ];
            };

            const startAnimation = () => {
                if (isBusy.value) return;
                reset();
                generateAnimationSteps();
                isBusy.value = true;
                isFinished.value = false;
                notyf.success(`已生成 ${animationSteps.value.length} 个动画步骤。`);
                nextStep();
            };

            const nextStep = () => {
                if (currentStepIndex.value >= animationSteps.value.length - 1) {
                    isFinished.value = true;
                    notyf.success('演示已结束！');
                    return;
                }
                
                currentStepIndex.value++;
                const step = animationSteps.value[currentStepIndex.value];

                explanation.value = step.exp || explanation.value;
                activeLine.value = step.line !== undefined ? step.line - 1 : activeLine.value;
                if(step.chart) {
                    updateChart(step.chart.node, step.chart.status);
                }

                const processAction = (action) => {
                    if (!action) return;
                    let frame = callStack.value.length > 0 ? callStack.value[0] : null;

                    switch (action.type) {
                        case 'stackPush': callStack.value.unshift(action.frame); break;
                        case 'stackPop': callStack.value.shift(); break;
                        case 'updateLocals': Object.assign(frame.locals, action.newLocals); break;
                        case 'updateStatus': Object.assign(frame, { statusText: action.statusText, statusClass: action.statusClass }); break;
                        case 'setReturn': Object.assign(frame, { returnValue: action.value, statusText: action.statusText, statusClass: action.statusClass }); break;
                        case 'multi': action.actions.forEach(processAction); break;
                    }
                };

                processAction(step.action);
            };
            
            const updateChart = (nodeName, status) => {
                const styles = {
                    inactive: { color: '#f1f5f9', borderColor: '#94a3b8', borderWidth: 2, },
                    highlight: { color: '#fef3c7', borderColor: '#f59e0b', borderWidth: 4, },
                    active: { color: '#dbeafe', borderColor: '#2563eb', borderWidth: 4, },
                };
                chartInstance.dispatchAction({
                    type: 'highlight',
                    seriesIndex: 0,
                    name: nodeName
                });
                chartInstance.setOption({
                    series: [{
                        nodes: [{ name: nodeName, itemStyle: styles[status] }]
                    }]
                });
            };

            onMounted(() => {
                chartInstance = echarts.init(document.getElementById('echarts-flow-container'));
                chartInstance.setOption({
                    tooltip: {},
                    series: [{
                        type: 'graph',
                        layout: 'none',
                        symbolSize: 120,
                        roam: false,
                        label: { show: true, fontSize: 16, fontWeight: 'bold' },
                        edgeSymbol: ['circle', 'arrow'],
                        edgeSymbolSize: [4, 10],
                        edgeLabel: {
                            show: true,
                            fontSize: 12,
                            formatter: (p) => p.data.label,
                            color: '#334155'
                        },
                        data: [
                            // === 修改点在这里：调整了 x 和 y 坐标实现纵向布局 ===
                            { name: 'main', x: 400, y: 150, itemStyle: { color: '#f1f5f9', borderColor: '#94a3b8', borderWidth: 2 } },
                            { name: 'calculate_score', x: 400, y: 450, itemStyle: { color: '#f1f5f9', borderColor: '#94a3b8', borderWidth: 2 } },
                        ],
                        links: [{
                            source: 'main',
                            target: 'calculate_score',
                            label: {
                                normal: {
                                    show: true,
                                    formatter: '调用(10)'
                                }
                            },
                            lineStyle: {
                                color: '#64748b',
                                width: 2,
                                // 调整曲率以适应纵向布局
                                curveness: 0.2
                            }
                        },{
                            source: 'calculate_score',
                            target: 'main',
                             label: {
                                normal: {
                                    show: true,
                                    formatter: '返回(150)'
                                }
                            },
                            lineStyle: {
                                color: '#9ca3af',
                                width: 2,
                                // 调整曲率以适应纵向布局
                                curveness: 0.2
                            }
                        }]
                    }]
                });
                window.addEventListener('resize', () => chartInstance && chartInstance.resize());
                reset();
            });

            return { isBusy, isFinished, explanation, activeLine, code, callStack, startAnimation, reset, nextStep };
        }
    }).mount('#app');
</script>

</body>
</html>