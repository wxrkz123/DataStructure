<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Red-Black Tree Complete Visualization</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #2d3748;
            overflow-x: hidden;
            min-height: 100vh;
        }

        .main-container {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            min-height: 100vh;
        }

        .node-circle {
            filter: drop-shadow(0 4px 12px rgba(0, 0, 0, 0.15));
            transition: all 0.3s ease;
            stroke-width: 3;
            stroke: rgba(255,255,255,0.3);
        }

        .node-circle:hover {
            filter: drop-shadow(0 8px 20px rgba(0, 0, 0, 0.25));
            transform: scale(1.05);
        }

        .edge-line {
            stroke: #64748b;
            stroke-width: 2.5;
            stroke-linecap: round;
        }
        
        .edge-line.nil-edge {
            stroke: #94a3b8;
            stroke-width: 2;
            stroke-dasharray: 4,4;
            opacity: 0.6;
        }

        .nil-node {
            opacity: 0.6;
            stroke-dasharray: 3,3;
            filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.1));
        }
        
        @keyframes rotateArrow {
            0% { opacity: 0; transform: scale(0.8); }
            50% { opacity: 1; transform: scale(1.1); }
            100% { opacity: 0; transform: scale(0.8); }
        }
        
        .rotation-arrow {
            animation: rotateArrow 2s ease-in-out infinite;
        }

        .control-panel {
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(0, 0, 0, 0.08);
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.08);
        }

        .btn-primary {
            background: linear-gradient(135deg, #dc2626 0%, #991b1b 100%);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .btn-primary:before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }

        .btn-primary:hover:before {
            left: 100%;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(220, 38, 38, 0.35);
        }
        
        .code-block {
            background: #0f172a;
            border-radius: 12px;
            padding: 20px;
            font-family: 'Fira Code', 'Consolas', monospace;
            font-size: 14px;
            line-height: 1.7;
            overflow-x: auto;
            color: #e2e8f0;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        }

        .code-highlight {
            background: rgba(251, 191, 36, 0.2);
            padding: 2px 6px;
            border-radius: 4px;
            transition: all 0.3s ease;
            border: 1px solid rgba(251, 191, 36, 0.4);
        }

        .code-comment {
            color: #64748b;
            font-style: italic;
        }
        
        .info-card {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(0, 0, 0, 0.06);
            border-radius: 16px;
            padding: 24px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.06);
        }

        .info-card:hover {
            border-color: rgba(220, 38, 38, 0.3);
            box-shadow: 0 8px 30px rgba(220, 38, 38, 0.08);
            transform: translateY(-2px);
        }

        .step-indicator {
            background: #f1f5f9;
            border: 2px solid #e2e8f0;
            color: #64748b;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .step-indicator.active {
            background: linear-gradient(135deg, #dc2626 0%, #991b1b 100%);
            border-color: #dc2626;
            color: white;
            transform: scale(1.15);
            box-shadow: 0 4px 15px rgba(220, 38, 38, 0.3);
        }

        .property-badge {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            margin: 2px;
            transition: all 0.3s ease;
        }

        .property-valid {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
        }

        .property-invalid {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white;
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .black-height-label {
            font-size: 11px;
            font-weight: bold;
            fill: #7c2d12;
        }

        .case-button {
            position: relative;
            overflow: hidden;
        }

        .case-button:before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }

        .case-button:hover:before {
            width: 300px;
            height: 300px;
        }

        ::-webkit-scrollbar { width: 10px; height: 10px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; border-radius: 5px; }
        ::-webkit-scrollbar-thumb { background: linear-gradient(135deg, #dc2626 0%, #991b1b 100%); border-radius: 5px; }
        ::-webkit-scrollbar-thumb:hover { background: linear-gradient(135deg, #991b1b 0%, #7f1d1d 100%); }
    </style>
</head>
<body>
    <div id="app" class="main-container">
        <header class="bg-white/95 backdrop-blur-xl border-b border-gray-200 sticky top-0 z-50 shadow-sm">
            <div class="container mx-auto px-6 py-5">
                <div class="flex items-center justify-between">
                    <div>
                        <h1 class="text-4xl font-bold bg-gradient-to-r from-red-600 via-purple-600 to-blue-600 bg-clip-text text-transparent">
                            Red-Black Tree Complete Visualization
                        </h1>
                        <p class="text-gray-600 mt-1">Interactive Learning Tool with Black Height Calculation</p>
                    </div>
                    <div class="flex items-center gap-3">
                        <button @click="showProperties = !showProperties" class="px-5 py-2.5 bg-gradient-to-r from-purple-500 to-indigo-500 text-white rounded-lg hover:shadow-lg transition-all">
                            <i class="fas fa-list-check mr-2"></i>
                            {{ showProperties ? 'Hide' : 'Show' }} Properties
                        </button>
                        <button @click="toggleExplanation" class="px-5 py-2.5 bg-gradient-to-r from-blue-500 to-cyan-500 text-white rounded-lg hover:shadow-lg transition-all">
                            <i class="fas fa-book-open mr-2"></i>
                            {{ showExplanation ? 'Hide' : 'Show' }} Theory
                        </button>
                        <button @click="resetAll" class="px-5 py-2.5 bg-gradient-to-r from-gray-500 to-gray-600 text-white rounded-lg hover:shadow-lg transition-all">
                            <i class="fas fa-redo mr-2"></i>
                            Reset
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <main class="container mx-auto px-6 py-8">
            <!-- Properties Panel -->
            <div v-if="showProperties" class="mb-8 info-card">
                <h3 class="text-xl font-bold mb-4 text-gray-800">
                    <i class="fas fa-clipboard-check mr-2 text-purple-600"></i>
                    Red-Black Tree Properties Validation
                </h3>
                <div class="grid grid-cols-1 md:grid-cols-5 gap-4">
                    <div v-for="(prop, index) in properties" :key="index" class="text-center">
                        <div :class="['property-badge', prop.valid ? 'property-valid' : 'property-invalid']">
                            <i :class="['fas', prop.valid ? 'fa-check' : 'fa-times', 'mr-1']"></i>
                            Property {{ index + 1 }}
                        </div>
                        <p class="text-xs text-gray-600 mt-2">{{ prop.description }}</p>
                    </div>
                </div>
                <div v-if="blackHeightInfo" class="mt-4 p-4 bg-gradient-to-r from-amber-50 to-orange-50 rounded-lg border border-amber-200">
                    <p class="text-sm font-semibold text-amber-800">
                        <i class="fas fa-ruler-vertical mr-2"></i>
                        Black Height Information:
                    </p>
                    <p class="text-sm text-amber-700 mt-1">{{ blackHeightInfo }}</p>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <!-- Control Panel -->
                <div class="lg:col-span-1">
                    <div class="control-panel p-6 sticky top-28">
                        <h2 class="text-2xl font-bold mb-6 bg-gradient-to-r from-red-600 to-pink-600 bg-clip-text text-transparent">
                            Control Center
                        </h2>
                        
                        <div class="mb-6">
                            <label class="block text-sm font-bold text-gray-700 mb-3">
                                <i class="fas fa-shapes mr-2 text-red-500"></i>
                                Select Case
                            </label>
                            <div class="grid grid-cols-1 gap-3">
                                <button 
                                    v-for="type in insertionCases" 
                                    :key="type.id"
                                    @click="selectCaseType(type.id)"
                                    :class="['case-button p-4 rounded-xl border-2 transition-all text-left relative', 
                                             selectedType === type.id 
                                             ? 'bg-gradient-to-r from-red-600 to-pink-600 border-red-600 text-white shadow-lg' 
                                             : 'bg-white border-gray-200 text-gray-700 hover:border-red-300 hover:shadow-md']"
                                >
                                    <div class="font-bold text-sm">{{ type.name }}</div>
                                    <div class="text-xs mt-1 opacity-90">{{ type.description }}</div>
                                    <div v-if="type.complexity" class="mt-2">
                                        <span class="text-xs px-2 py-1 rounded-full bg-white/20">
                                            {{ type.complexity }}
                                        </span>
                                    </div>
                                </button>
                            </div>
                        </div>
                        
                        <div class="mb-6">
                            <label class="block text-sm font-bold text-gray-700 mb-3">
                                <i class="fas fa-play-circle mr-2 text-green-500"></i>
                                Animation Control
                            </label>
                            <div class="space-y-3">
                                <button 
                                    @click="startAnimation"
                                    :disabled="isAnimating"
                                    class="w-full btn-primary py-3 px-6 rounded-xl text-white font-bold disabled:opacity-50 disabled:cursor-not-allowed shadow-md"
                                >
                                    <i :class="['fas mr-2', isAnimating ? 'fa-spinner fa-spin' : 'fa-play']"></i>
                                    {{ isAnimating ? 'Animating...' : 'Start Animation' }}
                                </button>
                                
                                <div class="flex gap-2">
                                    <button 
                                        @click="previousStep"
                                        :disabled="currentStep === 0 || isAnimating"
                                        class="flex-1 px-4 py-2.5 bg-gradient-to-r from-gray-200 to-gray-300 hover:from-gray-300 hover:to-gray-400 rounded-lg transition-all disabled:opacity-50 font-semibold"
                                    >
                                        <i class="fas fa-chevron-left mr-1"></i>
                                        Previous
                                    </button>
                                    <button 
                                        @click="nextStep"
                                        :disabled="currentStep >= maxSteps || isAnimating"
                                        class="flex-1 px-4 py-2.5 bg-gradient-to-r from-gray-200 to-gray-300 hover:from-gray-300 hover:to-gray-400 rounded-lg transition-all disabled:opacity-50 font-semibold"
                                    >
                                        Next
                                        <i class="fas fa-chevron-right ml-1"></i>
                                    </button>
                                </div>
                                
                                <button 
                                    @click="autoPlay = !autoPlay; if(autoPlay) startAutoPlay()"
                                    class="w-full px-4 py-2.5 bg-gradient-to-r from-purple-500 to-indigo-500 text-white rounded-lg hover:shadow-lg transition-all font-semibold"
                                >
                                    <i :class="['fas mr-2', autoPlay ? 'fa-pause' : 'fa-forward']"></i>
                                    {{ autoPlay ? 'Stop Auto-Play' : 'Auto-Play All Cases' }}
                                </button>
                            </div>
                        </div>
                        
                        <div class="mb-6">
                            <label class="block text-sm font-bold text-gray-700 mb-3">
                                <i class="fas fa-tachometer-alt mr-2 text-blue-500"></i>
                                Animation Speed: {{ animationSpeed }}ms
                            </label>
                            <input 
                                type="range" 
                                v-model="animationSpeed" 
                                min="500" 
                                max="3000" 
                                step="100"
                                class="w-full h-2 bg-gradient-to-r from-blue-200 to-purple-200 rounded-lg appearance-none cursor-pointer"
                            >
                        </div>
                        
                        <div class="space-y-3">
                            <label class="flex items-center cursor-pointer group">
                                <input type="checkbox" v-model="showRotationArrows" class="mr-3 w-5 h-5 text-red-600 bg-gray-100 border-gray-300 rounded focus:ring-red-500">
                                <span class="text-gray-700 group-hover:text-red-600 transition-colors">
                                    <i class="fas fa-sync-alt mr-2"></i>Show Rotation Arrows
                                </span>
                            </label>
                            <label class="flex items-center cursor-pointer group">
                                <input type="checkbox" v-model="showCode" class="mr-3 w-5 h-5 text-red-600 bg-gray-100 border-gray-300 rounded focus:ring-red-500">
                                <span class="text-gray-700 group-hover:text-red-600 transition-colors">
                                    <i class="fas fa-code mr-2"></i>Show Implementation Code
                                </span>
                            </label>
                            <label class="flex items-center cursor-pointer group">
                                <input type="checkbox" v-model="showNilNodes" class="mr-3 w-5 h-5 text-red-600 bg-gray-100 border-gray-300 rounded focus:ring-red-500">
                                <span class="text-gray-700 group-hover:text-red-600 transition-colors">
                                    <i class="fas fa-square mr-2"></i>Show NIL Nodes
                                </span>
                            </label>
                            <label class="flex items-center cursor-pointer group">
                                <input type="checkbox" v-model="showBlackHeight" class="mr-3 w-5 h-5 text-red-600 bg-gray-100 border-gray-300 rounded focus:ring-red-500">
                                <span class="text-gray-700 group-hover:text-red-600 transition-colors">
                                    <i class="fas fa-ruler-vertical mr-2"></i>Show Black Heights (BH)
                                </span>
                            </label>
                        </div>
                    </div>
                </div>
                
                <!-- Visualization Area -->
                <div class="lg:col-span-2">
                    <!-- Step Indicators -->
                    <div class="mb-6 flex items-center justify-center gap-3 flex-wrap">
                        <div 
                            v-for="(step, index) in steps" 
                            :key="index"
                            @click="!isAnimating && goToStep(index)"
                            :class="['step-indicator w-12 h-12 rounded-full flex items-center justify-center text-sm font-bold',
                                     currentStep === index ? 'active' : '']"
                            :title="step.title"
                        >
                            {{ index + 1 }}
                        </div>
                    </div>
                    
                    <!-- Tree Visualization -->
                    <div class="bg-white/70 rounded-2xl p-8 border-2 border-gray-100 shadow-xl backdrop-blur-sm">
                        <svg 
                            :width="svgWidth" 
                            :height="svgHeight" 
                            class="w-full"
                            viewBox="0 0 900 600"
                        >
                            <defs>
                                <linearGradient id="redGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                                    <stop offset="0%" style="stop-color:#ef4444;" />
                                    <stop offset="100%" style="stop-color:#dc2626;" />
                                </linearGradient>
                                <linearGradient id="blackGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                                    <stop offset="0%" style="stop-color:#374151;" />
                                    <stop offset="100%" style="stop-color:#111827;" />
                                </linearGradient>
                                <marker id="arrowhead" markerWidth="10" markerHeight="7" 
                                        refX="9" refY="3.5" orient="auto">
                                    <polygon points="0 0, 10 3.5, 0 7" fill="#dc2626" />
                                </marker>
                            </defs>
                            
                            <!-- Edges -->
                            <g class="edges">
                                <line 
                                    v-for="edge in currentEdges" 
                                    :key="edge.id"
                                    :x1="edge.x1" 
                                    :y1="edge.y1" 
                                    :x2="edge.x2" 
                                    :y2="edge.y2"
                                    :class="['edge-line', edge.toNil ? 'nil-edge' : '']"
                                />
                            </g>
                            
                            <!-- Rotation Arrows -->
                            <g v-if="showRotationArrows && rotationArrow" class="rotation-arrows">
                                <path 
                                    :d="rotationArrow.path"
                                    fill="none"
                                    stroke="#dc2626"
                                    stroke-width="3"
                                    marker-end="url(#arrowhead)"
                                    class="rotation-arrow"
                                    stroke-dasharray="5,5"
                                />
                                <text 
                                    :x="rotationArrow.textX" 
                                    :y="rotationArrow.textY" 
                                    fill="#dc2626" 
                                    class="font-bold text-sm" 
                                    text-anchor="middle"
                                >
                                    {{ rotationArrow.text }}
                                </text>
                            </g>
                            
                            <!-- Nodes -->
                            <g class="nodes">
                                <g 
                                    v-for="node in visibleNodes" 
                                    :key="node.id"
                                    :transform="`translate(${node.x}, ${node.y})`"
                                    class="node"
                                >
                                    <!-- NIL nodes as squares -->
                                    <rect 
                                        v-if="node.isNil"
                                        :x="-20" 
                                        :y="-20" 
                                        width="40" 
                                        height="40"
                                        rx="5"
                                        :fill="getNodeColor(node)" 
                                        class="nil-node"
                                        stroke="rgba(255,255,255,0.3)"
                                        stroke-width="2"
                                    />
                                    <!-- Regular nodes as circles -->
                                    <circle 
                                        v-else
                                        :r="35" 
                                        :fill="getNodeColor(node)" 
                                        class="node-circle"
                                    />
                                    <text 
                                        text-anchor="middle" 
                                        dy="5" 
                                        :class="['font-bold pointer-events-none', node.isNil ? 'text-xs' : 'text-lg']"
                                        fill="white"
                                    >
                                        {{ node.label }}
                                    </text>
                                    <!-- Black Height Label -->
                                    <g v-if="showBlackHeight && node.blackHeight !== undefined && !node.isNil">
                                        <rect 
                                            :x="22" 
                                            :y="-35" 
                                            width="28" 
                                            height="20" 
                                            rx="3"
                                            fill="#fbbf24"
                                            opacity="0.9"
                                        />
                                        <text 
                                            :x="36" 
                                            :y="-20" 
                                            class="black-height-label"
                                            text-anchor="middle"
                                        >
                                            BH:{{ node.blackHeight }}
                                        </text>
                                    </g>
                                    <!-- Highlight for violated node -->
                                    <circle 
                                        v-if="node.violated" 
                                        :r="node.isNil ? 25 : 40" 
                                        fill="none" 
                                        stroke="#fbbf24" 
                                        stroke-width="3"
                                        stroke-dasharray="5,5"
                                        class="rotation-arrow"
                                    />
                                </g>
                            </g>
                        </svg>
                    </div>
                    
                    <!-- Current Step Info -->
                    <div class="mt-6 info-card">
                        <div class="flex items-start justify-between">
                            <div class="flex-1">
                                <h3 class="text-xl font-bold mb-3 text-red-600">
                                    <i class="fas fa-layer-group mr-2"></i>
                                    Step {{ currentStep + 1 }}: {{ steps[currentStep]?.title }}
                                </h3>
                                <p class="text-gray-700 leading-relaxed">
                                    {{ steps[currentStep]?.description }}
                                </p>
                                <div v-if="steps[currentStep]?.details" class="mt-4 p-4 bg-blue-50 rounded-lg border border-blue-200">
                                    <p class="text-sm text-blue-800">
                                        <i class="fas fa-info-circle mr-2"></i>
                                        <strong>Details:</strong> {{ steps[currentStep].details }}
                                    </p>
                                </div>
                            </div>
                            <div v-if="steps[currentStep]?.violation" class="ml-4">
                                <span class="property-badge property-invalid">
                                    <i class="fas fa-exclamation-triangle mr-1"></i>
                                    {{ steps[currentStep].violation }}
                                </span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Code Display -->
                    <div v-if="showCode" class="mt-6">
                        <h3 class="text-xl font-bold mb-4 text-gray-800">
                            <i class="fas fa-code mr-2 text-purple-600"></i>
                            Implementation Code
                        </h3>
                        <div class="code-block">
                            <pre><code v-html="currentCode"></code></pre>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Theory Section -->
            <div v-if="showExplanation" class="mt-12 grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="info-card">
                    <h3 class="text-xl font-bold mb-4 text-red-600">
                        <i class="fas fa-tree mr-2"></i>Red-Black Tree Properties
                    </h3>
                    <ol class="space-y-3 text-gray-700">
                        <li><span class="font-semibold text-red-700">1. Node Color:</span> Every node is either red or black.</li>
                        <li><span class="font-semibold text-red-700">2. Root Property:</span> The root is always black.</li>
                        <li><span class="font-semibold text-red-700">3. Leaf Property:</span> Every leaf (NIL) is black.</li>
                        <li><span class="font-semibold text-red-700">4. Red Property:</span> If a node is red, both its children are black (no two red nodes in a row).</li>
                        <li><span class="font-semibold text-red-700">5. Black Height:</span> Every path from a node to its descendant NIL nodes contains the same number of black nodes.</li>
                    </ol>
                </div>
                
                <div class="info-card">
                    <h3 class="text-xl font-bold mb-4 text-purple-600">
                        <i class="fas fa-ruler-vertical mr-2"></i>Black Height Explained
                    </h3>
                    <p class="text-gray-700 mb-4">
                        The <strong>black height</strong> of a node is the number of black nodes on any path from that node to a leaf (NIL), not counting the node itself.
                    </p>
                    <ul class="space-y-2 text-gray-700">
                        <li><i class="fas fa-check text-green-500 mr-2"></i>NIL nodes have black height 0</li>
                        <li><i class="fas fa-check text-green-500 mr-2"></i>Leaf nodes (with NIL children) have black height 1</li>
                        <li><i class="fas fa-check text-green-500 mr-2"></i>This property ensures the tree is balanced</li>
                        <li><i class="fas fa-check text-green-500 mr-2"></i>Height is at most 2×log(n+1)</li>
                    </ul>
                </div>
                
                <div class="info-card">
                    <h3 class="text-xl font-bold mb-4 text-blue-600">
                        <i class="fas fa-sync-alt mr-2"></i>Fix-up Cases
                    </h3>
                    <div class="space-y-3 text-gray-700">
                        <div class="p-3 bg-red-50 rounded-lg">
                            <span class="font-semibold text-red-700">Case 1 (Red Uncle):</span> 
                            Recolor parent, uncle (black) and grandparent (red). Move up.
                        </div>
                        <div class="p-3 bg-purple-50 rounded-lg">
                            <span class="font-semibold text-purple-700">Case 2 (Black Uncle, Inner):</span> 
                            Double rotation: first on parent, then on grandparent.
                        </div>
                        <div class="p-3 bg-blue-50 rounded-lg">
                            <span class="font-semibold text-blue-700">Case 3 (Black Uncle, Outer):</span> 
                            Single rotation on grandparent and recolor.
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Complexity Analysis -->
            <div v-if="showExplanation" class="mt-6 info-card">
                <h3 class="text-xl font-bold mb-4 text-green-600">
                    <i class="fas fa-chart-line mr-2"></i>Time Complexity Analysis
                </h3>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="text-center">
                        <div class="text-3xl font-bold text-green-600 mb-2">O(log n)</div>
                        <p class="text-gray-600">Search Operation</p>
                    </div>
                    <div class="text-center">
                        <div class="text-3xl font-bold text-blue-600 mb-2">O(log n)</div>
                        <p class="text-gray-600">Insert Operation</p>
                    </div>
                    <div class="text-center">
                        <div class="text-3xl font-bold text-purple-600 mb-2">O(log n)</div>
                        <p class="text-gray-600">Delete Operation</p>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        const { createApp } = Vue;
        
        createApp({
            data() {
                return {
                    svgWidth: 900,
                    svgHeight: 600,
                    insertionCases: [
                        { id: 'RECOLOR', name: 'Case 1: Red Uncle', description: 'Parent and uncle are red - recolor only', complexity: 'Simple' },
                        { id: 'LL', name: 'Case 2a: Left-Left', description: 'Black uncle, outer case (LL)', complexity: 'Single Rotation' },
                        { id: 'RR', name: 'Case 2b: Right-Right', description: 'Black uncle, outer case (RR)', complexity: 'Single Rotation' },
                        { id: 'LR', name: 'Case 3a: Left-Right', description: 'Black uncle, inner case (LR)', complexity: 'Double Rotation' },
                        { id: 'RL', name: 'Case 3b: Right-Left', description: 'Black uncle, inner case (RL)', complexity: 'Double Rotation' },
                    ],
                    selectedType: 'LR',
                    currentStep: 0,
                    isAnimating: false,
                    autoPlay: false,
                    animationSpeed: 1500,
                    showRotationArrows: true,
                    showCode: false,
                    showExplanation: false,
                    showNilNodes: true,
                    showBlackHeight: true,
                    showProperties: true,
                    currentNodes: [],
                    currentEdges: [],
                    rotationArrow: null,
                    steps: [],
                    maxSteps: 0,
                    treeStates: {},
                    properties: [
                        { valid: true, description: 'All nodes are red or black' },
                        { valid: true, description: 'Root is black' },
                        { valid: true, description: 'All leaves (NIL) are black' },
                        { valid: true, description: 'No two red nodes in a row' },
                        { valid: true, description: 'Same black height on all paths' }
                    ],
                    blackHeightInfo: ''
                };
            },
            
            computed: {
                visibleNodes() {
                    return this.showNilNodes ? this.currentNodes : this.currentNodes.filter(n => !n.isNil);
                },
                
                currentCode() {
                    const codes = {
                        'LL': `<span class="code-comment">// Left-Left Case: Single Right Rotation</span>
<span class="code-highlight">function fixLeftLeft(Node* grandparent)</span> {
    Node* parent = grandparent->left;
    <span class="code-comment">// Perform right rotation on grandparent</span>
    <span class="code-highlight">rotateRight(grandparent);</span>
    <span class="code-comment">// Recolor: parent becomes black, grandparent becomes red</span>
    <span class="code-highlight">parent->color = BLACK;</span>
    <span class="code-highlight">grandparent->color = RED;</span>
}`,
                        'RR': `<span class="code-comment">// Right-Right Case: Single Left Rotation</span>
<span class="code-highlight">function fixRightRight(Node* grandparent)</span> {
    Node* parent = grandparent->right;
    <span class="code-comment">// Perform left rotation on grandparent</span>
    <span class="code-highlight">rotateLeft(grandparent);</span>
    <span class="code-comment">// Recolor: parent becomes black, grandparent becomes red</span>
    <span class="code-highlight">parent->color = BLACK;</span>
    <span class="code-highlight">grandparent->color = RED;</span>
}`,
                        'LR': `<span class="code-comment">// Left-Right Case: Double Rotation</span>
<span class="code-highlight">function fixLeftRight(Node* grandparent)</span> {
    Node* parent = grandparent->left;
    Node* node = parent->right;
    <span class="code-comment">// Step 1: Left rotation on parent</span>
    <span class="code-highlight">rotateLeft(parent);</span>
    <span class="code-comment">// Step 2: Right rotation on grandparent</span>
    <span class="code-highlight">rotateRight(grandparent);</span>
    <span class="code-comment">// Step 3: Recolor</span>
    <span class="code-highlight">node->color = BLACK;</span>
    <span class="code-highlight">grandparent->color = RED;</span>
}`,
                        'RL': `<span class="code-comment">// Right-Left Case: Double Rotation</span>
<span class="code-highlight">function fixRightLeft(Node* grandparent)</span> {
    Node* parent = grandparent->right;
    Node* node = parent->left;
    <span class="code-comment">// Step 1: Right rotation on parent</span>
    <span class="code-highlight">rotateRight(parent);</span>
    <span class="code-comment">// Step 2: Left rotation on grandparent</span>
    <span class="code-highlight">rotateLeft(grandparent);</span>
    <span class="code-comment">// Step 3: Recolor</span>
    <span class="code-highlight">node->color = BLACK;</span>
    <span class="code-highlight">grandparent->color = RED;</span>
}`,
                        'RECOLOR': `<span class="code-comment">// Case 1: Uncle is Red - Recoloring Only</span>
<span class="code-highlight">function fixRedUncle(Node* grandparent)</span> {
    Node* parent = /* red parent */;
    Node* uncle = /* red uncle */;
    <span class="code-comment">// Recolor parent and uncle to black</span>
    <span class="code-highlight">parent->color = BLACK;</span>
    <span class="code-highlight">uncle->color = BLACK;</span>
    <span class="code-comment">// Recolor grandparent to red (if not root)</span>
    if (grandparent != root) {
        <span class="code-highlight">grandparent->color = RED;</span>
    }
}`
                    };
                    return codes[this.selectedType] || '';
                }
            },
            
            mounted() {
                this.defineAllTreeStates();
                this.initializeTree();
            },
            
            methods: {
                initializeTree() {
                    this.setupSteps();
                    this.currentStep = 0;
                    this.setTreeState(this.currentStep);
                },

                defineAllTreeStates() {
                    this.treeStates = {
                        'RECOLOR': [
                            { // Step 1: Initial Violation
                                nodes: [
                                    { id: 'G', label: '20', x: 450, y: 100, color: 'black', blackHeight: 2 },
                                    { id: 'P', label: '10', x: 300, y: 200, color: 'red', blackHeight: 1 },
                                    { id: 'U', label: '30', x: 600, y: 200, color: 'red', blackHeight: 1 },
                                    { id: 'N', label: '5', x: 200, y: 300, color: 'red', violated: true, blackHeight: 1 },
                                    { id: 'T1', label: '15', x: 400, y: 300, color: 'black', blackHeight: 1 },
                                    { id: 'T2', label: '25', x: 500, y: 300, color: 'black', blackHeight: 1 },
                                    { id: 'T3', label: '35', x: 700, y: 300, color: 'black', blackHeight: 1 },
                                    { id: 'N-NIL-L', label: 'NIL', x: 160, y: 400, color: 'black', isNil: true },
                                    { id: 'N-NIL-R', label: 'NIL', x: 240, y: 400, color: 'black', isNil: true },
                                    { id: 'T1-NIL-L', label: 'NIL', x: 360, y: 400, color: 'black', isNil: true },
                                    { id: 'T1-NIL-R', label: 'NIL', x: 440, y: 400, color: 'black', isNil: true },
                                    { id: 'T2-NIL-L', label: 'NIL', x: 460, y: 400, color: 'black', isNil: true },
                                    { id: 'T2-NIL-R', label: 'NIL', x: 540, y: 400, color: 'black', isNil: true },
                                    { id: 'T3-NIL-L', label: 'NIL', x: 660, y: 400, color: 'black', isNil: true },
                                    { id: 'T3-NIL-R', label: 'NIL', x: 740, y: 400, color: 'black', isNil: true },
                                ],
                                edges: [
                                    { id: 'G-P' }, { id: 'G-U' }, { id: 'P-N' }, { id: 'P-T1' }, { id: 'U-T2' }, { id: 'U-T3' },
                                    { id: 'N-N-NIL-L', toNil: true }, { id: 'N-N-NIL-R', toNil: true },
                                    { id: 'T1-T1-NIL-L', toNil: true }, { id: 'T1-T1-NIL-R', toNil: true },
                                    { id: 'T2-T2-NIL-L', toNil: true }, { id: 'T2-T2-NIL-R', toNil: true },
                                    { id: 'T3-T3-NIL-L', toNil: true }, { id: 'T3-T3-NIL-R', toNil: true },
                                ],
                                arrow: { path: 'M 300 170 C 450 170, 450 230, 600 230', text: 'Recolor P, U, G', textX: 450, textY: 190 }
                            },
                            { // Step 2: Final State
                                nodes: [
                                    { id: 'G', label: '20', x: 450, y: 100, color: 'black', blackHeight: 2 },
                                    { id: 'P', label: '10', x: 300, y: 200, color: 'black', blackHeight: 1 },
                                    { id: 'U', label: '30', x: 600, y: 200, color: 'black', blackHeight: 1 },
                                    { id: 'N', label: '5', x: 200, y: 300, color: 'red', blackHeight: 1 },
                                    { id: 'T1', label: '15', x: 400, y: 300, color: 'black', blackHeight: 1 },
                                    { id: 'T2', label: '25', x: 500, y: 300, color: 'black', blackHeight: 1 },
                                    { id: 'T3', label: '35', x: 700, y: 300, color: 'black', blackHeight: 1 },
                                    { id: 'N-NIL-L', label: 'NIL', x: 160, y: 400, color: 'black', isNil: true },
                                    { id: 'N-NIL-R', label: 'NIL', x: 240, y: 400, color: 'black', isNil: true },
                                    { id: 'T1-NIL-L', label: 'NIL', x: 360, y: 400, color: 'black', isNil: true },
                                    { id: 'T1-NIL-R', label: 'NIL', x: 440, y: 400, color: 'black', isNil: true },
                                    { id: 'T2-NIL-L', label: 'NIL', x: 460, y: 400, color: 'black', isNil: true },
                                    { id: 'T2-NIL-R', label: 'NIL', x: 540, y: 400, color: 'black', isNil: true },
                                    { id: 'T3-NIL-L', label: 'NIL', x: 660, y: 400, color: 'black', isNil: true },
                                    { id: 'T3-NIL-R', label: 'NIL', x: 740, y: 400, color: 'black', isNil: true },
                                ],
                                edges: [
                                    { id: 'G-P' }, { id: 'G-U' }, { id: 'P-N' }, { id: 'P-T1' }, { id: 'U-T2' }, { id: 'U-T3' },
                                    { id: 'N-N-NIL-L', toNil: true }, { id: 'N-N-NIL-R', toNil: true },
                                    { id: 'T1-T1-NIL-L', toNil: true }, { id: 'T1-T1-NIL-R', toNil: true },
                                    { id: 'T2-T2-NIL-L', toNil: true }, { id: 'T2-T2-NIL-R', toNil: true },
                                    { id: 'T3-T3-NIL-L', toNil: true }, { id: 'T3-T3-NIL-R', toNil: true },
                                ],
                                arrow: null
                            }
                        ],
                        'LL': [
                             { // Step 1: Initial Violation
                                nodes: [
                                    { id: 'G', label: '30', x: 450, y: 100, color: 'black', blackHeight: 2 },
                                    { id: 'P', label: '20', x: 300, y: 200, color: 'red', blackHeight: 1 },
                                    { id: 'U', label: '40', x: 600, y: 200, color: 'black', blackHeight: 1 },
                                    { id: 'N', label: '10', x: 200, y: 300, color: 'red', violated: true, blackHeight: 1 },
                                    { id: 'T2', label: '25', x: 400, y: 300, color: 'black', blackHeight: 1 },
                                    { id: 'N-NIL-L', label: 'NIL', x: 160, y: 400, color: 'black', isNil: true },
                                    { id: 'N-NIL-R', label: 'NIL', x: 240, y: 400, color: 'black', isNil: true },
                                    { id: 'T2-NIL-L', label: 'NIL', x: 360, y: 400, color: 'black', isNil: true },
                                    { id: 'T2-NIL-R', label: 'NIL', x: 440, y: 400, color: 'black', isNil: true },
                                    { id: 'U-NIL-L', label: 'NIL', x: 560, y: 300, color: 'black', isNil: true },
                                    { id: 'U-NIL-R', label: 'NIL', x: 640, y: 300, color: 'black', isNil: true },
                                ],
                                edges: [
                                    { id: 'G-P' }, { id: 'G-U' }, { id: 'P-N' }, { id: 'P-T2' },
                                    { id: 'N-N-NIL-L', toNil: true }, { id: 'N-N-NIL-R', toNil: true },
                                    { id: 'T2-T2-NIL-L', toNil: true }, { id: 'T2-T2-NIL-R', toNil: true },
                                    { id: 'U-U-NIL-L', toNil: true }, { id: 'U-U-NIL-R', toNil: true },
                                ],
                                arrow: { path: 'M 450 130 Q 390 165 450 200', text: 'Right Rotate on G', textX: 360, textY: 170 }
                            },
                            { // Step 2: Final State
                                nodes: [
                                    { id: 'P', label: '20', x: 450, y: 100, color: 'black', blackHeight: 2 },
                                    { id: 'N', label: '10', x: 300, y: 200, color: 'red', blackHeight: 1 },
                                    { id: 'G', label: '30', x: 600, y: 200, color: 'red', blackHeight: 1 },
                                    { id: 'T2', label: '25', x: 500, y: 300, color: 'black', blackHeight: 1 },
                                    { id: 'U', label: '40', x: 700, y: 300, color: 'black', blackHeight: 1 },
                                    { id: 'N-NIL-L', label: 'NIL', x: 260, y: 300, color: 'black', isNil: true },
                                    { id: 'N-NIL-R', label: 'NIL', x: 340, y: 300, color: 'black', isNil: true },
                                    { id: 'T2-NIL-L', label: 'NIL', x: 460, y: 400, color: 'black', isNil: true },
                                    { id: 'T2-NIL-R', label: 'NIL', x: 540, y: 400, color: 'black', isNil: true },
                                    { id: 'U-NIL-L', label: 'NIL', x: 660, y: 400, color: 'black', isNil: true },
                                    { id: 'U-NIL-R', label: 'NIL', x: 740, y: 400, color: 'black', isNil: true },
                                ],
                                edges: [
                                    { id: 'P-N' }, { id: 'P-G' }, { id: 'G-T2' }, { id: 'G-U' },
                                    { id: 'N-N-NIL-L', toNil: true }, { id: 'N-N-NIL-R', toNil: true },
                                    { id: 'T2-T2-NIL-L', toNil: true }, { id: 'T2-T2-NIL-R', toNil: true },
                                    { id: 'U-U-NIL-L', toNil: true }, { id: 'U-U-NIL-R', toNil: true },
                                ],
                                arrow: null
                            }
                        ],
                        'RR': [
                           { // Step 1: Initial Violation
                                nodes: [
                                    { id: 'G', label: '20', x: 450, y: 100, color: 'black', blackHeight: 2 },
                                    { id: 'U', label: '10', x: 300, y: 200, color: 'black', blackHeight: 1 },
                                    { id: 'P', label: '30', x: 600, y: 200, color: 'red', blackHeight: 1 },
                                    { id: 'T2', label: '25', x: 500, y: 300, color: 'black', blackHeight: 1 },
                                    { id: 'N', label: '40', x: 700, y: 300, color: 'red', violated: true, blackHeight: 1 },
                                    { id: 'U-NIL-L', label: 'NIL', x: 260, y: 300, color: 'black', isNil: true },
                                    { id: 'U-NIL-R', label: 'NIL', x: 340, y: 300, color: 'black', isNil: true },
                                    { id: 'T2-NIL-L', label: 'NIL', x: 460, y: 400, color: 'black', isNil: true },
                                    { id: 'T2-NIL-R', label: 'NIL', x: 540, y: 400, color: 'black', isNil: true },
                                    { id: 'N-NIL-L', label: 'NIL', x: 660, y: 400, color: 'black', isNil: true },
                                    { id: 'N-NIL-R', label: 'NIL', x: 740, y: 400, color: 'black', isNil: true },
                                ],
                                edges: [
                                    { id: 'G-U' }, { id: 'G-P' }, { id: 'P-T2' }, { id: 'P-N' },
                                    { id: 'U-U-NIL-L', toNil: true }, { id: 'U-U-NIL-R', toNil: true },
                                    { id: 'T2-T2-NIL-L', toNil: true }, { id: 'T2-T2-NIL-R', toNil: true },
                                    { id: 'N-N-NIL-L', toNil: true }, { id: 'N-N-NIL-R', toNil: true },
                                ],
                                arrow: { path: 'M 450 130 Q 510 165 450 200', text: 'Left Rotate on G', textX: 540, textY: 170 }
                            },
                            { // Step 2: Final State
                                nodes: [
                                    { id: 'P', label: '30', x: 450, y: 100, color: 'black', blackHeight: 2 },
                                    { id: 'G', label: '20', x: 300, y: 200, color: 'red', blackHeight: 1 },
                                    { id: 'N', label: '40', x: 600, y: 200, color: 'red', blackHeight: 1 },
                                    { id: 'U', label: '10', x: 200, y: 300, color: 'black', blackHeight: 1 },
                                    { id: 'T2', label: '25', x: 400, y: 300, color: 'black', blackHeight: 1 },
                                    { id: 'U-NIL-L', label: 'NIL', x: 160, y: 400, color: 'black', isNil: true },
                                    { id: 'U-NIL-R', label: 'NIL', x: 240, y: 400, color: 'black', isNil: true },
                                    { id: 'T2-NIL-L', label: 'NIL', x: 360, y: 400, color: 'black', isNil: true },
                                    { id: 'T2-NIL-R', label: 'NIL', x: 440, y: 400, color: 'black', isNil: true },
                                    { id: 'N-NIL-L', label: 'NIL', x: 560, y: 300, color: 'black', isNil: true },
                                    { id: 'N-NIL-R', label: 'NIL', x: 640, y: 300, color: 'black', isNil: true },
                                ],
                                edges: [
                                    { id: 'P-G' }, { id: 'P-N' }, { id: 'G-U' }, { id: 'G-T2' },
                                    { id: 'U-U-NIL-L', toNil: true }, { id: 'U-U-NIL-R', toNil: true },
                                    { id: 'T2-T2-NIL-L', toNil: true }, { id: 'T2-T2-NIL-R', toNil: true },
                                    { id: 'N-N-NIL-L', toNil: true }, { id: 'N-N-NIL-R', toNil: true },
                                ],
                                arrow: null
                            }
                        ],
                        'LR': [
                            { // Step 1: Initial Violation
                                nodes: [
                                    { id: 'G', label: '30', x: 450, y: 100, color: 'black', blackHeight: 2 },
                                    { id: 'P', label: '10', x: 300, y: 200, color: 'red', blackHeight: 1 },
                                    { id: 'U', label: '40', x: 600, y: 200, color: 'black', blackHeight: 1 },
                                    { id: 'T1', label: '5', x: 200, y: 300, color: 'black', blackHeight: 1 },
                                    { id: 'N', label: '20', x: 400, y: 300, color: 'red', violated: true, blackHeight: 1 },
                                    { id: 'T1-NIL-L', label: 'NIL', x: 160, y: 400, color: 'black', isNil: true },
                                    { id: 'T1-NIL-R', label: 'NIL', x: 240, y: 400, color: 'black', isNil: true },
                                    { id: 'N-NIL-L', label: 'NIL', x: 360, y: 400, color: 'black', isNil: true },
                                    { id: 'N-NIL-R', label: 'NIL', x: 440, y: 400, color: 'black', isNil: true },
                                    { id: 'U-NIL-L', label: 'NIL', x: 560, y: 300, color: 'black', isNil: true },
                                    { id: 'U-NIL-R', label: 'NIL', x: 640, y: 300, color: 'black', isNil: true },
                                ],
                                edges: [
                                    { id: 'G-P' }, { id: 'G-U' }, { id: 'P-T1' }, { id: 'P-N' },
                                    { id: 'T1-T1-NIL-L', toNil: true }, { id: 'T1-T1-NIL-R', toNil: true },
                                    { id: 'N-N-NIL-L', toNil: true }, { id: 'N-N-NIL-R', toNil: true },
                                    { id: 'U-U-NIL-L', toNil: true }, { id: 'U-U-NIL-R', toNil: true },
                                ],
                                arrow: { path: 'M 300 230 Q 330 265 300 300', text: 'Left Rotate on P', textX: 350, textY: 270 }
                            },
                            { // Step 2: After Left Rotation (becomes LL)
                                nodes: [
                                    { id: 'G', label: '30', x: 450, y: 100, color: 'black', blackHeight: 2 },
                                    { id: 'N', label: '20', x: 300, y: 200, color: 'red', blackHeight: 1 },
                                    { id: 'U', label: '40', x: 600, y: 200, color: 'black', blackHeight: 1 },
                                    { id: 'P', label: '10', x: 200, y: 300, color: 'red', violated: true, blackHeight: 1 },
                                    { id: 'T1', label: '5', x: 100, y: 400, color: 'black', blackHeight: 1 },
                                    { id: 'N-NIL-R', label: 'NIL', x: 400, y: 300, color: 'black', isNil: true }, // Was N's right, now N's right
                                    { id: 'T1-NIL-L', label: 'NIL', x: 60, y: 500, color: 'black', isNil: true },
                                    { id: 'T1-NIL-R', label: 'NIL', x: 140, y: 500, color: 'black', isNil: true },
                                    { id: 'P-NIL-R', label: 'NIL', x: 300, y: 400, color: 'black', isNil: true }, // Was N's left, now P's right
                                    { id: 'U-NIL-L', label: 'NIL', x: 560, y: 300, color: 'black', isNil: true },
                                    { id: 'U-NIL-R', label: 'NIL', x: 640, y: 300, color: 'black', isNil: true },
                                ],
                                edges: [
                                    { id: 'G-N' }, { id: 'G-U' }, { id: 'N-P' }, { id: 'N-N-NIL-R', toNil: true},
                                    { id: 'P-T1' }, { id: 'P-P-NIL-R', toNil: true },
                                    { id: 'T1-T1-NIL-L', toNil: true }, { id: 'T1-T1-NIL-R', toNil: true },
                                    { id: 'U-U-NIL-L', toNil: true }, { id: 'U-U-NIL-R', toNil: true },
                                ],
                                arrow: { path: 'M 450 130 Q 390 165 450 200', text: 'Right Rotate on G', textX: 360, textY: 170 }
                            },
                            { // Step 3: Final State
                                nodes: [
                                    { id: 'N', label: '20', x: 450, y: 100, color: 'black', blackHeight: 2 },
                                    { id: 'P', label: '10', x: 300, y: 200, color: 'red', blackHeight: 1 },
                                    { id: 'G', label: '30', x: 600, y: 200, color: 'red', blackHeight: 1 },
                                    { id: 'T1', label: '5', x: 200, y: 300, color: 'black', blackHeight: 1 },
                                    { id: 'U', label: '40', x: 700, y: 300, color: 'black', blackHeight: 1 },
                                    { id: 'P-NIL-R', label: 'NIL', x: 400, y: 300, color: 'black', isNil: true }, // former N's left, now P's right
                                    { id: 'T1-NIL-L', label: 'NIL', x: 160, y: 400, color: 'black', isNil: true },
                                    { id: 'T1-NIL-R', label: 'NIL', x: 240, y: 400, color: 'black', isNil: true },
                                    { id: 'N-NIL-R', label: 'NIL', x: 500, y: 300, color: 'black', isNil: true }, // former G's left, now N's right
                                    { id: 'U-NIL-L', label: 'NIL', x: 660, y: 400, color: 'black', isNil: true },
                                    { id: 'U-NIL-R', label: 'NIL', x: 740, y: 400, color: 'black', isNil: true },
                                ],
                                edges: [
                                    { id: 'N-P' }, { id: 'N-G' },
                                    { id: 'P-T1' }, { id: 'P-P-NIL-R', toNil: true },
                                    { id: 'G-N-NIL-R', toNil: true }, { id: 'G-U' },
                                    { id: 'T1-T1-NIL-L', toNil: true }, { id: 'T1-T1-NIL-R', toNil: true },
                                    { id: 'U-U-NIL-L', toNil: true }, { id: 'U-U-NIL-R', toNil: true },
                                ],
                                arrow: null
                            }
                        ],
                        'RL': [
                            { // Step 1: Initial Violation
                                nodes: [
                                    { id: 'G', label: '20', x: 450, y: 100, color: 'black', blackHeight: 2 },
                                    { id: 'U', label: '10', x: 300, y: 200, color: 'black', blackHeight: 1 },
                                    { id: 'P', label: '40', x: 600, y: 200, color: 'red', blackHeight: 1 },
                                    { id: 'N', label: '30', x: 500, y: 300, color: 'red', violated: true, blackHeight: 1 },
                                    { id: 'T3', label: '50', x: 700, y: 300, color: 'black', blackHeight: 1 },
                                    { id: 'U-NIL-L', label: 'NIL', x: 260, y: 300, color: 'black', isNil: true },
                                    { id: 'U-NIL-R', label: 'NIL', x: 340, y: 300, color: 'black', isNil: true },
                                    { id: 'N-NIL-L', label: 'NIL', x: 460, y: 400, color: 'black', isNil: true },
                                    { id: 'N-NIL-R', label: 'NIL', x: 540, y: 400, color: 'black', isNil: true },
                                    { id: 'T3-NIL-L', label: 'NIL', x: 660, y: 400, color: 'black', isNil: true },
                                    { id: 'T3-NIL-R', label: 'NIL', x: 740, y: 400, color: 'black', isNil: true },
                                ],
                                edges: [
                                    { id: 'G-U' }, { id: 'G-P' }, { id: 'P-N' }, { id: 'P-T3' },
                                    { id: 'U-U-NIL-L', toNil: true }, { id: 'U-U-NIL-R', toNil: true },
                                    { id: 'N-N-NIL-L', toNil: true }, { id: 'N-N-NIL-R', toNil: true },
                                    { id: 'T3-T3-NIL-L', toNil: true }, { id: 'T3-T3-NIL-R', toNil: true },
                                ],
                                arrow: { path: 'M 600 230 Q 570 265 600 300', text: 'Right Rotate on P', textX: 530, textY: 270 }
                            },
                            { // Step 2: After Right Rotation (becomes RR)
                                nodes: [
                                    { id: 'G', label: '20', x: 450, y: 100, color: 'black', blackHeight: 2 },
                                    { id: 'U', label: '10', x: 300, y: 200, color: 'black', blackHeight: 1 },
                                    { id: 'N', label: '30', x: 600, y: 200, color: 'red', blackHeight: 1 },
                                    { id: 'P', label: '40', x: 700, y: 300, color: 'red', violated: true, blackHeight: 1 },
                                    { id: 'T3', label: '50', x: 800, y: 400, color: 'black', blackHeight: 1 },
                                    { id: 'U-NIL-L', label: 'NIL', x: 260, y: 300, color: 'black', isNil: true },
                                    { id: 'U-NIL-R', label: 'NIL', x: 340, y: 300, color: 'black', isNil: true },
                                    { id: 'N-NIL-L', label: 'NIL', x: 500, y: 300, color: 'black', isNil: true },
                                    { id: 'T3-NIL-L', label: 'NIL', x: 760, y: 500, color: 'black', isNil: true },
                                    { id: 'T3-NIL-R', label: 'NIL', x: 840, y: 500, color: 'black', isNil: true },
                                    { id: 'P-NIL-L', label: 'NIL', x: 600, y: 400, color: 'black', isNil: true },
                                ],
                                edges: [
                                    { id: 'G-U' }, { id: 'G-N' }, { id: 'N-P' }, { id: 'N-N-NIL-L', toNil: true },
                                    { id: 'P-P-NIL-L', toNil: true }, { id: 'P-T3' },
                                    { id: 'U-U-NIL-L', toNil: true }, { id: 'U-U-NIL-R', toNil: true },
                                    { id: 'T3-T3-NIL-L', toNil: true }, { id: 'T3-T3-NIL-R', toNil: true },
                                ],
                                arrow: { path: 'M 450 130 Q 510 165 450 200', text: 'Left Rotate on G', textX: 540, textY: 170 }
                            },
                            { // Step 3: Final State
                                nodes: [
                                    { id: 'N', label: '30', x: 450, y: 100, color: 'black', blackHeight: 2 },
                                    { id: 'G', label: '20', x: 300, y: 200, color: 'red', blackHeight: 1 },
                                    { id: 'P', label: '40', x: 600, y: 200, color: 'red', blackHeight: 1 },
                                    { id: 'U', label: '10', x: 200, y: 300, color: 'black', blackHeight: 1 },
                                    { id: 'T3', label: '50', x: 700, y: 300, color: 'black', blackHeight: 1 },
                                    { id: 'G-NIL-R', label: 'NIL', x: 400, y: 300, color: 'black', isNil: true },
                                    { id: 'P-NIL-L', label: 'NIL', x: 500, y: 300, color: 'black', isNil: true },
                                    { id: 'U-NIL-L', label: 'NIL', x: 160, y: 400, color: 'black', isNil: true },
                                    { id: 'U-NIL-R', label: 'NIL', x: 240, y: 400, color: 'black', isNil: true },
                                    { id: 'T3-NIL-L', label: 'NIL', x: 660, y: 400, color: 'black', isNil: true },
                                    { id: 'T3-NIL-R', label: 'NIL', x: 740, y: 400, color: 'black', isNil: true },
                                ],
                                edges: [
                                    { id: 'N-G' }, { id: 'N-P' },
                                    { id: 'G-U' }, { id: 'G-G-NIL-R', toNil: true },
                                    { id: 'P-P-NIL-L', toNil: true }, { id: 'P-T3' },
                                    { id: 'U-U-NIL-L', toNil: true }, { id: 'U-U-NIL-R', toNil: true },
                                    { id: 'T3-T3-NIL-L', toNil: true }, { id: 'T3-T3-NIL-R', toNil: true },
                                ],
                                arrow: null
                            }
                        ],
                    };
                },
                
                setupSteps() {
                    const stepConfigs = {
                        'LL': [ { title: 'Initial Violation', description: 'New red node (10) inserted as left child of red parent (20). Uncle (40) is black. This is a Left-Left case.', details: 'The violation occurs because we have two consecutive red nodes. Since the uncle is black and the violation forms a straight line (left-left), we fix it with one rotation.', violation: 'Property 4 Violated' }, { title: 'Final State', description: 'After a Right Rotation on the grandparent (30) and recoloring, the tree is balanced. The former parent (20) is the new black root of this subtree.', details: 'All red-black tree properties are now satisfied.', violation: null } ],
                        'RR': [ { title: 'Initial Violation', description: 'New red node (40) inserted as right child of red parent (30). Uncle (10) is black. This is a Right-Right case.', details: 'This is the mirror case of Left-Left. The violation requires a single left rotation on the grandparent (20) to be fixed.', violation: 'Property 4 Violated' }, { title: 'Final State', description: 'After a Left Rotation on the grandparent (20) and recoloring, the properties are restored.', details: 'The tree is now a valid Red-Black Tree.', violation: null } ],
                        'LR': [ { title: 'Initial Violation', description: 'New red node (20) is the right child of a red left parent (10). This creates a "zig-zag" pattern, a Left-Right case.', details: 'This "inner" case cannot be fixed with a single rotation. It requires two steps.', violation: 'Property 4 Violated' }, { title: 'Transform to LL Case', description: 'A Left Rotation on the parent (10) transforms the subtree into a simpler Left-Left case.', details: 'The violation still exists, but it is now in a straight line, which is easier to fix.', violation: 'Property 4 Still Violated' }, { title: 'Final State', description: 'A Right Rotation on the grandparent (30) and recoloring fixes the LL case. The new node (20) becomes the subtree root.', details: 'The tree is now fully balanced and all properties hold.', violation: null } ],
                        'RL': [ { title: 'Initial Violation', description: 'New red node (30) is the left child of a red right parent (40). This is a Right-Left case.', details: 'This is the mirror of the LR case, forming a "zig-zag" to the right.', violation: 'Property 4 Violated' }, { title: 'Transform to RR Case', description: 'A Right Rotation on the parent (40) transforms the subtree into a simpler Right-Right case.', details: 'The violation has been converted to an "outer" case, ready for the final fix.', violation: 'Property 4 Still Violated' }, { title: 'Final State', description: 'A Left Rotation on the grandparent (20) and recoloring fixes the RR case. The tree is now balanced.', details: 'All red-black properties are now satisfied.', violation: null } ],
                        'RECOLOR': [ { title: 'Red Uncle Case', description: 'New node (5) and parent (10) are red. Crucially, the uncle (30) is also red.', details: 'When the uncle is red, no rotations are needed. We simply recolor.', violation: 'Property 4 Violated' }, { title: 'Final State', description: 'Parent (10) and uncle (30) are recolored black. Grandparent (20) is recolored red. Since the grandparent is the root, it is immediately recolored back to black.', details: 'The fix is simple and local. The black height of the tree remains unchanged.', violation: null } ],
                    };
                    
                    this.steps = stepConfigs[this.selectedType] || [];
                    this.maxSteps = this.steps.length - 1;
                },
                
                validateProperties() {
                    const state = this.treeStates[this.selectedType]?.[this.currentStep];
                    if (!state) return;
                    
                    const nodes = state.nodes.filter(n => !n.isNil);
                    const root = nodes.length > 0 ? nodes.reduce((a, b) => a.y < b.y ? a : b) : null;

                    this.properties[0].valid = nodes.every(n => n.color === 'red' || n.color === 'black');
                    this.properties[1].valid = !root || root.color === 'black';
                    this.properties[2].valid = state.nodes.filter(n => n.isNil).every(n => n.color === 'black');
                    
                    let redViolation = false;
                    const nodeMap = new Map(nodes.map(n => [n.id, n]));
                    for (let edge of state.edges) {
                        if (edge.toNil) continue;
                        const [fromId, toId] = edge.id.split('-');
                        const fromNode = nodeMap.get(fromId);
                        const toNode = nodeMap.get(toId);
                        if (fromNode && toNode && fromNode.color === 'red' && toNode.color === 'red') {
                            redViolation = true;
                            break;
                        }
                    }
                    this.properties[3].valid = !redViolation;
                    
                    let blackHeightSame = true;
                    let pathBlackHeight = -1;
                    if (root) {
                        const nodeMapWithNil = new Map(state.nodes.map(n => [n.id, n]));
                        const edgeMap = new Map();
                        state.edges.forEach(e => {
                            const [from, to] = e.id.split('-');
                            if (!edgeMap.has(from)) edgeMap.set(from, []);
                            edgeMap.get(from).push(to);
                        });

                        const traverse = (nodeId, currentBh) => {
                            const node = nodeMapWithNil.get(nodeId);
                            if (!node || !blackHeightSame) return;
                            
                            if (node.color === 'black') currentBh++;
                            
                            if (node.isNil){
                                if (pathBlackHeight === -1) pathBlackHeight = currentBh;
                                else if (pathBlackHeight !== currentBh) blackHeightSame = false;
                                return;
                            }
                            
                            const children = edgeMap.get(nodeId) || [];
                            if (children.length === 0) { 
                                if (pathBlackHeight === -1) pathBlackHeight = currentBh;
                                else if (pathBlackHeight !== currentBh) blackHeightSame = false;
                            } else {
                                for(const childId of children){
                                    traverse(childId, currentBh);
                                }
                            }
                        };
                        traverse(root.id, 0);
                    }
                    this.properties[4].valid = blackHeightSame;
                    
                    if (root) {
                        this.blackHeightInfo = `Root black height is ${root.blackHeight}. A valid RBT has the same black height on all root-to-leaf paths. Validation status: ${blackHeightSame ? 'Valid' : 'Invalid'}.`;
                    } else {
                        this.blackHeightInfo = 'The tree is empty.';
                    }
                },
                
                setTreeState(step) {
                    const state = this.treeStates[this.selectedType]?.[step];
                    if (!state) return;

                    this.currentNodes = JSON.parse(JSON.stringify(state.nodes));
                    this.updateEdges();
                    this.rotationArrow = state.arrow;
                    this.validateProperties();
                },
                
                updateEdges() {
                    const nodeMap = new Map(this.currentNodes.map(n => [n.id, {x: n.x, y: n.y}]));
                    const state = this.treeStates[this.selectedType]?.[this.currentStep];
                    if (!state) return;
                    
                    const nodeDataMap = new Map(this.currentNodes.map(n => [n.id, n]));

                    const newEdges = [];
                    for(const edge of state.edges) {
                        const [fromId, toId] = edge.id.split('-');
                        const fromNodePos = nodeMap.get(fromId);
                        const toNodePos = nodeMap.get(toId);
                        
                        if(fromNodePos && toNodePos) {
                            const fromNodeData = nodeDataMap.get(fromId);
                            const toNodeData = nodeDataMap.get(toId);
                            
                            const angle = Math.atan2(toNodePos.y - fromNodePos.y, toNodePos.x - fromNodePos.x);
                            const fromRadius = fromNodeData?.isNil ? 20 : 35;
                            const toRadius = toNodeData?.isNil ? 20 : 35;

                            newEdges.push({
                                id: edge.id,
                                x1: fromNodePos.x + fromRadius * Math.cos(angle), 
                                y1: fromNodePos.y + fromRadius * Math.sin(angle),
                                x2: toNodePos.x - toRadius * Math.cos(angle), 
                                y2: toNodePos.y - toRadius * Math.sin(angle),
                                toNil: !!edge.toNil
                            });
                        }
                    }
                    this.currentEdges = newEdges;
                },

                getNodeColor(node) {
                    if (node.isNil) return '#475569';
                    return node.color === 'red' ? 'url(#redGradient)' : 'url(#blackGradient)';
                },
                
                selectCaseType(type) {
                    if(this.isAnimating) return;
                    this.selectedType = type;
                    this.initializeTree();
                },
                
                goToStep(step) {
                    if (this.isAnimating) return;
                    this.currentStep = step;
                    this.setTreeState(step);
                },
                
                async startAnimation() {
                    if (this.isAnimating || this.maxSteps === 0) return;
                    
                    this.isAnimating = true;
                    try {
                        this.currentStep = 0;
                        this.setTreeState(0);
                        
                        for (let i = 0; i < this.maxSteps; i++) {
                            await this.sleep(this.animationSpeed / 3);
                            await this.animateStep(i, i + 1);
                        }
                    } catch (error) {
                        console.error("Animation failed:", error);
                        this.initializeTree(); 
                    } finally {
                        this.isAnimating = false;
                    }
                },
                
                async startAutoPlay() {
                    if (!this.autoPlay) return;
                    
                    const allCases = this.insertionCases.map(c => c.id);
                    let currentIndex = allCases.indexOf(this.selectedType);

                    while(this.autoPlay) {
                        await this.startAnimation();
                        await this.sleep(this.animationSpeed * 1.5);
                        
                        if (!this.autoPlay) break;

                        currentIndex = (currentIndex + 1) % allCases.length;
                        this.selectCaseType(allCases[currentIndex]);
                        await this.sleep(500);
                    }
                },
                
                async nextStep() {
                    if (this.currentStep < this.maxSteps && !this.isAnimating) {
                       await this.animateStep(this.currentStep, this.currentStep + 1);
                    }
                },
                
                async previousStep() {
                    if (this.currentStep > 0 && !this.isAnimating) {
                        await this.animateStep(this.currentStep, this.currentStep - 1);
                    }
                },

                animateStep(fromStep, toStep) {
                     return new Promise((resolve, reject) => {
                        this.isAnimating = true;
                        
                        const startState = this.treeStates[this.selectedType][fromStep];
                        const endState = this.treeStates[this.selectedType][toStep];
                        if (!startState || !endState) return reject("Invalid animation state.");

                        const startNodesMap = new Map(startState.nodes.map(n => [n.id, n]));
                        const endNodesMap = new Map(endState.nodes.map(n => [n.id, n]));
                        
                        this.rotationArrow = startState.arrow;

                        const duration = this.animationSpeed;
                        let startTime = null;

                        const animationFrame = (timestamp) => {
                            try {
                                if (!startTime) startTime = timestamp;
                                const elapsed = timestamp - startTime;
                                const progress = Math.min(elapsed / duration, 1);
                                const easedProgress = 0.5 - 0.5 * Math.cos(progress * Math.PI);

                                for (const node of this.currentNodes) {
                                    const startNode = startNodesMap.get(node.id);
                                    const endNode = endNodesMap.get(node.id);
                                    
                                    if(startNode && endNode) { 
                                        node.x = startNode.x + (endNode.x - startNode.x) * easedProgress;
                                        node.y = startNode.y + (endNode.y - startNode.y) * easedProgress;
                                        if (progress > 0.5) {
                                            node.color = endNode.color;
                                            node.blackHeight = endNode.blackHeight;
                                            node.violated = endNode.violated;
                                        }
                                    }
                                }
                                this.updateEdges();
                                
                                if (progress >= 1) {
                                    this.currentStep = toStep;
                                    this.setTreeState(toStep);
                                    this.isAnimating = false;
                                    resolve();
                                } else {
                                    requestAnimationFrame(animationFrame);
                                }
                            } catch (error) {
                                console.error("Error during animation frame:", error);
                                this.isAnimating = false;
                                reject(error);
                            }
                        };
                        requestAnimationFrame(animationFrame);
                    });
                },
                
                toggleExplanation() { 
                    this.showExplanation = !this.showExplanation; 
                },
                
                resetAll() {
                    if(this.isAnimating) {
                        this.isAnimating = false;
                        this.autoPlay = false;
                    }
                    this.selectedType = 'RECOLOR';
                    this.autoPlay = false;
                    this.initializeTree();
                },
                
                sleep(ms) { 
                    return new Promise(resolve => setTimeout(resolve, ms)); 
                }
            }
        }).mount('#app');
    </script>
</body>
</html>